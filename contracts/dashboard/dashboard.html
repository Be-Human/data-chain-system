<!-- dashboard.html - ä¿å­˜åˆ°é¡¹ç›®æ ¹ç›®å½• -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Hardhat Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 { 
            text-align: center; 
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card h2 {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #ffd700;
        }
        .stat {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .stat:last-child { border: none; }
        .label { opacity: 0.8; }
        .value { 
            font-weight: bold; 
            font-family: 'SF Mono', monospace;
        }
        .address {
            font-size: 0.85em;
            word-break: break-all;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
        }
        .status.connected {
            background: #4caf50;
        }
        .status.disconnected {
            background: #f44336;
        }
        .tx-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .tx-item {
            padding: 10px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 0.9em;
        }
        .btn {
            background: linear-gradient(45deg, #FE6B8B 30%, #FF8E53 90%);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
            transition: all 0.3s;
        }
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        #logs {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            font-family: 'SF Mono', monospace;
            font-size: 0.85em;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            padding: 2px 0;
        }
        .log-time { color: #ffd700; }
        .log-info { color: #4caf50; }
        .log-error { color: #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Hardhat Dashboard</h1>
        
        <div class="grid">
            <!-- è¿æ¥çŠ¶æ€ -->
            <div class="card">
                <h2>âš¡ è¿æ¥çŠ¶æ€</h2>
                <div class="stat">
                    <span class="label">çŠ¶æ€</span>
                    <span class="status disconnected" id="status">æœªè¿æ¥</span>
                </div>
                <div class="stat">
                    <span class="label">Chain ID</span>
                    <span class="value" id="chainId">-</span>
                </div>
                <div class="stat">
                    <span class="label">å½“å‰åŒºå—</span>
                    <span class="value" id="blockNumber">-</span>
                </div>
                <!-- dashboard.html - ç»­æ¥ä¸Šé¢çš„ä»£ç  -->
                <div class="stat">
                    <span class="label">Gas Price</span>
                    <span class="value" id="gasPrice">-</span>
                </div>
            </div>
            
            <!-- è´¦æˆ·ä¿¡æ¯ -->
            <div class="card">
                <h2>ğŸ’° æµ‹è¯•è´¦æˆ·</h2>
                <div id="accounts"></div>
            </div>
            
            <!-- åˆçº¦ä¿¡æ¯ -->
            <div class="card">
                <h2>ğŸ“„ åˆçº¦æ•°æ®</h2>
                <div id="contractInfo">
                    <div class="stat">
                        <span class="label">ç­‰å¾…éƒ¨ç½²...</span>
                    </div>
                </div>
            </div>
            
            <!-- æœ€è¿‘äº¤æ˜“ -->
            <div class="card">
                <h2>ğŸ“ æœ€è¿‘äº¤æ˜“</h2>
                <div class="tx-list" id="transactions">
                    <div class="tx-item">æš‚æ— äº¤æ˜“</div>
                </div>
            </div>
        </div>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <div class="card">
            <h2>ğŸ® å¿«é€Ÿæ“ä½œ</h2>
            <button class="btn" onclick="sendTestTx()">å‘é€æµ‹è¯•äº¤æ˜“</button>
            <button class="btn" onclick="deployContract()">éƒ¨ç½²åˆçº¦</button>
            <button class="btn" onclick="queryContract()">æŸ¥è¯¢åˆçº¦</button>
            <button class="btn" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
            <button class="btn" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
        </div>
        
        <!-- å®æ—¶æ—¥å¿— -->
        <div class="card">
            <h2>ğŸ“Š å®æ—¶æ—¥å¿—</h2>
            <div id="logs"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.1/dist/ethers.umd.min.js"></script>
    <script>
        let provider;
        let signer;
        let contractAddress = localStorage.getItem('contractAddress');
        const transactions = [];
        
        // åˆå§‹åŒ–
        async function init() {
            try {
                provider = new ethers.JsonRpcProvider('http://localhost:8545');
                await provider.getBlockNumber();
                
                document.getElementById('status').className = 'status connected';
                document.getElementById('status').textContent = 'å·²è¿æ¥';
                
                const accounts = await provider.listAccounts();
                if (accounts.length > 0) {
                    signer = await provider.getSigner(0);
                }
                
                await updateDashboard();
                startMonitoring();
                
                addLog('log-info', 'âœ… Dashboard å¯åŠ¨æˆåŠŸ');
            } catch (error) {
                document.getElementById('status').className = 'status disconnected';
                document.getElementById('status').textContent = 'è¿æ¥å¤±è´¥';
                addLog('log-error', 'âŒ è¿æ¥å¤±è´¥: ' + error.message);
                
                // 5ç§’åé‡è¯•
                setTimeout(init, 5000);
            }
        }
        
        // æ›´æ–°ä»ªè¡¨æ¿
        async function updateDashboard() {
            try {
                // åŸºç¡€ä¿¡æ¯
                const network = await provider.getNetwork();
                document.getElementById('chainId').textContent = network.chainId;
                
                const blockNumber = await provider.getBlockNumber();
                document.getElementById('blockNumber').textContent = blockNumber;
                
                const feeData = await provider.getFeeData();
                document.getElementById('gasPrice').textContent = 
                    ethers.formatUnits(feeData.gasPrice || 0, 'gwei') + ' Gwei';
                
                // è´¦æˆ·ä¿¡æ¯
                await updateAccounts();
                
                // åˆçº¦ä¿¡æ¯
                if (contractAddress) {
                    await updateContractInfo();
                }
                
            } catch (error) {
                console.error('æ›´æ–°å¤±è´¥:', error);
            }
        }
        
        // æ›´æ–°è´¦æˆ·
        async function updateAccounts() {
            const accountsDiv = document.getElementById('accounts');
            const accounts = [
                '0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266',
                '0x70997970C51812dc3A010C7d01b50e0d17dc79C8',
                '0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC'
            ];
            
            let html = '';
            for (let i = 0; i < accounts.length; i++) {
                const balance = await provider.getBalance(accounts[i]);
                html += `
                    <div class="stat">
                        <span class="label">è´¦æˆ· ${i}</span>
                        <span class="value">${ethers.formatEther(balance).substring(0, 8)} ETH</span>
                    </div>
                    <div class="address">${accounts[i].substring(0, 20)}...</div>
                `;
            }
            accountsDiv.innerHTML = html;
        }
        
        // æ›´æ–°åˆçº¦ä¿¡æ¯
        async function updateContractInfo() {
            try {
                // SimpleToken ABI
                const abi = [
                    "function name() view returns (string)",
                    "function symbol() view returns (string)",
                    "function totalSupply() view returns (uint256)",
                    "function balanceOf(address) view returns (uint256)"
                ];
                
                const contract = new ethers.Contract(contractAddress, abi, provider);
                const name = await contract.name();
                const symbol = await contract.symbol();
                const totalSupply = await contract.totalSupply();
                
                document.getElementById('contractInfo').innerHTML = `
                    <div class="stat">
                        <span class="label">åˆçº¦åœ°å€</span>
                        <span class="value address">${contractAddress.substring(0, 20)}...</span>
                    </div>
                    <div class="stat">
                        <span class="label">ä»£å¸åç§°</span>
                        <span class="value">${name}</span>
                    </div>
                    <div class="stat">
                        <span class="label">ä»£å¸ç¬¦å·</span>
                        <span class="value">${symbol}</span>
                    </div>
                    <div class="stat">
                        <span class="label">æ€»ä¾›åº”é‡</span>
                        <span class="value">${ethers.formatUnits(totalSupply, 18)}</span>
                    </div>
                `;
            } catch (error) {
                console.error('åˆçº¦æŸ¥è¯¢å¤±è´¥:', error);
            }
        }
        
        // ç›‘å¬æ–°åŒºå—
        function startMonitoring() {
            provider.on('block', async (blockNumber) => {
                addLog('log-info', `ğŸ“¦ æ–°åŒºå— #${blockNumber}`);
                await updateDashboard();
                
                // è·å–åŒºå—äº¤æ˜“
                const block = await provider.getBlock(blockNumber, true);
                if (block && block.transactions.length > 0) {
                    block.transactions.forEach(tx => {
                        transactions.unshift({
                            hash: tx.hash,
                            from: tx.from,
                            to: tx.to,
                            value: ethers.formatEther(tx.value)
                        });
                    });
                    
                    // ä¿æŒæœ€å¤š10æ¡
                    transactions.splice(10);
                    updateTransactions();
                }
            });
        }
        
        // æ›´æ–°äº¤æ˜“åˆ—è¡¨
        function updateTransactions() {
            const txDiv = document.getElementById('transactions');
            if (transactions.length === 0) {
                txDiv.innerHTML = '<div class="tx-item">æš‚æ— äº¤æ˜“</div>';
                return;
            }
            
            txDiv.innerHTML = transactions.map(tx => `
                <div class="tx-item">
                    <strong>${tx.hash.substring(0, 10)}...</strong><br>
                    ${tx.from.substring(0, 10)}... â†’ ${tx.to ? tx.to.substring(0, 10) + '...' : 'Contract'}<br>
                    ğŸ’° ${tx.value} ETH
                </div>
            `).join('');
        }
        
        // å‘é€æµ‹è¯•äº¤æ˜“
        async function sendTestTx() {
            if (!signer) {
                alert('æ²¡æœ‰å¯ç”¨çš„ç­¾åè´¦æˆ·');
                return;
            }
            
            try {
                addLog('log-info', 'â³ å‘é€æµ‹è¯•äº¤æ˜“...');
                const tx = await signer.sendTransaction({
                    to: '0x70997970C51812dc3A010C7d01b50e0d17dc79C8',
                    value: ethers.parseEther('1.0')
                });
                addLog('log-info', `ğŸ“¤ äº¤æ˜“å·²å‘é€: ${tx.hash.substring(0, 20)}...`);
                
                await tx.wait();
                addLog('log-info', `âœ… äº¤æ˜“ç¡®è®¤: ${tx.hash.substring(0, 20)}...`);
            } catch (error) {
                addLog('log-error', 'âŒ äº¤æ˜“å¤±è´¥: ' + error.message);
            }
        }
        
        // éƒ¨ç½²åˆçº¦
        async function deployContract() {
            if (!signer) {
                alert('æ²¡æœ‰å¯ç”¨çš„ç­¾åè´¦æˆ·');
                return;
            }
            
            // SimpleToken å­—èŠ‚ç ï¼ˆç¤ºä¾‹ï¼‰
            const bytecode = "0x608060405234801561001057600080fd5b5060405161..."; // å®é™…å­—èŠ‚ç å¤ªé•¿ï¼Œè¿™é‡Œç®€åŒ–
            const abi = ["constructor(uint256)"];
            
            try {
                addLog('log-info', 'â³ éƒ¨ç½²åˆçº¦...');
                const factory = new ethers.ContractFactory(abi, bytecode, signer);
                const contract = await factory.deploy(1000000);
                
                addLog('log-info', `ğŸ“„ åˆçº¦éƒ¨ç½²ä¸­: ${contract.target}`);
                await contract.waitForDeployment();
                
                contractAddress = contract.target;
                localStorage.setItem('contractAddress', contractAddress);
                
                addLog('log-info', `âœ… åˆçº¦éƒ¨ç½²æˆåŠŸ: ${contractAddress}`);
                await updateContractInfo();
            } catch (error) {
                addLog('log-error', 'âŒ éƒ¨ç½²å¤±è´¥: ' + error.message);
            }
        }
        
        // æŸ¥è¯¢åˆçº¦
        async function queryContract() {
            const address = prompt('è¾“å…¥åˆçº¦åœ°å€:', contractAddress || '');
            if (address) {
                contractAddress = address;
                localStorage.setItem('contractAddress', contractAddress);
                await updateContractInfo();
                addLog('log-info', `ğŸ” æŸ¥è¯¢åˆçº¦: ${address}`);
            }
        }
        
        // æ·»åŠ æ—¥å¿—
        function addLog(className, message) {
            const logs = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + className;
            entry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
            logs.insertBefore(entry, logs.firstChild);
            
            // é™åˆ¶100æ¡
            while (logs.children.length > 100) {
                logs.removeChild(logs.lastChild);
            }
        }
        
        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            addLog('log-info', 'ğŸ“ æ—¥å¿—å·²æ¸…ç©º');
        }
        
        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const data = {
                transactions: transactions,
                contractAddress: contractAddress,
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `hardhat-data-${Date.now()}.json`;
            a.click();
            
            addLog('log-info', 'ğŸ“¥ æ•°æ®å·²å¯¼å‡º');
        }
        
        // å¯åŠ¨
        init();
        
        // æ¯5ç§’æ›´æ–°ä¸€æ¬¡
        setInterval(updateDashboard, 5000);
        
        // é¡µé¢å…³é—­æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (provider) {
                provider.removeAllListeners();
            }
        });
    </script>
</body>
</html>